# 🤖 AI开发指南

> **本文件是AI助手在修改本项目时的必读指南和工作流程**

---

## 📖 开始任何修改前必读

在对本项目进行任何修改之前，你必须：

1. **阅读 `PROJECT_STRUCTURE.md`** - 了解项目架构、文件关系、现有功能
2. **理解你的修改会影响哪些部分** - 检查文件的"关联文件"部分
3. **遵守项目规范** - 见下方规则清单

---

## ⚙️ AI工作流程

```
┌─────────────────────────────────────────────────────────────┐
│  用户提出需求                                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  第1步：阅读 PROJECT_STRUCTURE.md                            │
│  • 定位相关文件                                              │
│  • 了解文件职责和关联关系                                    │
│  • 检查现有功能实现                                          │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  第2步：检查必备规则（见下方清单）                           │
│  • 新页面必备功能清单                                        │
│  • 新组件必备功能清单                                        │
│  • API修改必备步骤                                           │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  第3步：实施修改                                             │
│  • 遵循现有代码风格                                          │
│  • 使用项目已有的工具函数和组件                              │
│  • 确保所有必备功能都已实现                                  │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  第4步：同步更新 PROJECT_STRUCTURE.md                        │
│  • 新增/删除文件 → 更新项目结构树                            │
│  • 修改功能 → 更新对应文件的功能说明                         │
│  • 修改关联关系 → 更新"关联文件"部分                         │
│  • 更新"更新记录"表格                                        │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  第5步：验证完成                                             │
│  • 检查是否有遗漏的必备功能                                  │
│  • 验证文档更新是否完整                                      │
│  • 确认所有翻译已添加                                        │
└─────────────────────────────────────────────────────────────┘
```

---

## ✅ 新建页面必备功能清单

创建任何新页面组件（`pages/*.tsx`）时，必须包含：

### 1. 🌍 国际化支持（必需）
```tsx
import { useTranslation } from 'react-i18next';

export default function NewPage() {
  const { t } = useTranslation();
  return <h1>{t('moduleName.key')}</h1>;
}
```
- [ ] 导入 `useTranslation`
- [ ] 所有用户可见文本使用 `t()` 函数
- [ ] 在 `locales/en.json` 和 `locales/zh.json` 添加翻译
- [ ] 错误消息使用 `humanizeError(e)`

### 2. 🎨 统一UI样式（必需）
```tsx
// 容器
<div className="max-w-6xl mx-auto p-4 pb-20">

// 按钮
<button className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">

// 输入框
<input className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white" />

// 卡片
<div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
```

### 3. 🚨 统一错误处理（必需）
```tsx
import toast from 'react-hot-toast';
import { humanizeError } from '../utils/humanizeError';

try {
  await apiFetch(...);
} catch (e: any) {
  toast.error(humanizeError(e));
}
```

### 4. ⏳ 加载状态（必需）
```tsx
const [loading, setLoading] = useState(false);

// 页面加载
{loading && <div>Loading...</div>}

// 按钮加载
<button disabled={loading}>
  {loading ? t('common.submitting') : t('common.submit')}
</button>
```

### 5. 📭 空状态处理（必需）
```tsx
{data.length === 0 && (
  <div className="text-center text-gray-400 py-12">
    {t('common.noData')}
  </div>
)}
```

### 6. 🔗 路由导航（必需）
```tsx
import { useNavigate, Link } from 'react-router-dom';

// 使用 Link 组件而非 <a>
<Link to="/path" className="...">Link Text</Link>

// 编程式导航
const navigate = useNavigate();
navigate('/path');
```

### 7. 🔐 权限控制（如需要）
```tsx
// 在 App.tsx 中用 ProtectedRoute 包裹
<Route path="/admin/*" element={
  <ProtectedRoute requireRole="admin">
    <AdminPage />
  </ProtectedRoute>
} />

// 页面内权限检查
const { user } = useAuth();
if (user?.role !== 'admin') {
  return <div>{t('auth.forbidden')}</div>;
}
```

### 8. 📱 响应式设计（必需）
```tsx
// 使用响应式Tailwind类
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<div className="flex flex-col md:flex-row gap-4">
```

---

## ✅ 新建组件必备功能清单

创建通用组件（`components/*.tsx`）时：

- [ ] 文件顶部添加注释说明功能
- [ ] 导出的Props类型定义清晰
- [ ] 支持国际化（如有文本）
- [ ] 可复用性强，不耦合特定业务逻辑
- [ ] 更新 `PROJECT_STRUCTURE.md` 的组件列表
- [ ] 记录该组件被哪些页面使用

---

## ✅ 修改API端点必备步骤

修改后端API（`server/src/routes/*.js`）时：

- [ ] 在对应controller中实现逻辑
- [ ] 添加合适的中间件（`requireAuth`, `requireRole`, `validate`）
- [ ] 更新相关model schema（如需要）
- [ ] 在前端 `api.ts` 或页面中添加对应的fetch调用
- [ ] 更新 `PROJECT_STRUCTURE.md` 的API说明

---

## ✅ 国际化（i18n）规则

### 翻译文件结构

`locales/en.json` 和 `locales/zh.json` 使用**模块化结构**：

```json
{
  "common": { "save": "Save", "cancel": "Cancel" },
  "auth": { "login": "Log In", "register": "Sign Up" },
  "idea": { "title": "Title", "content": "Content" },
  "admin": { "users": "Users", "ideas": "Ideas" },
  ...
}
```

### 添加新翻译

1. **确定模块名** - 根据功能归属（auth, idea, admin, profile等）
2. **同时更新两个文件** - `en.json` 和 `zh.json`
3. **使用嵌套键** - `t('moduleName.keyName')`
4. **变量插值** - `t('key', { variable: value })`

### 翻译完整性检查

- [ ] 所有按钮文本已翻译
- [ ] 所有标题和提示文本已翻译
- [ ] 所有表单标签和占位符已翻译
- [ ] 所有错误消息已翻译（使用 `humanizeError`）
- [ ] 所有空状态提示已翻译
- [ ] 所有toast通知已翻译

---

## 📁 文件命名和组织规范

### 前端
- **页面组件**: `XxxPage.tsx` （如 `LoginPage.tsx`）
- **通用组件**: `XxxComponent.tsx` （如 `Navbar.tsx`）
- **工具函数**: `camelCase.ts` （如 `humanizeError.ts`）
- **类型定义**: 使用 TypeScript interface/type

### 后端
- **路由**: `xxx.routes.js` （如 `auth.routes.js`）
- **控制器**: `xxx.controller.js` （如 `auth.controller.js`）
- **模型**: `Xxx.js` （如 `User.js`，首字母大写）
- **服务**: `xxx.service.js` （如 `email.service.js`）
- **中间件**: `xxx.js` （如 `auth.js`）

---

## 🔄 文档同步规则

### 何时更新 `PROJECT_STRUCTURE.md`

| 修改类型 | 需要更新的部分 |
|---------|---------------|
| 新增页面/组件 | 项目结构树 + 核心文件详解（新增对应章节） |
| 删除文件 | 项目结构树 + 移除对应章节 |
| 修改路由 | `App.tsx` 章节的路由表 |
| 新增功能 | 对应文件的"功能"部分 |
| 修改文件关联 | 对应文件的"关联文件"部分 |
| 添加翻译模块 | 国际化资源章节的模块结构和键数 |
| 重构代码 | 对应文件的"关键逻辑"部分 |

### 文档更新格式

每次更新后，必须在"更新记录"表格添加：

```markdown
| 2026-02-XX | X.X | 添加XXX功能，更新XXX文件说明 |
```

---

## 🎯 参考现有实现

在实现新功能前，查找项目中类似的现有实现作为参考：

### 完整实现的参考页面

- **完整CRUD页面**: `IdeaDetailPage.tsx` - 最复杂，包含所有交互
- **表单页面**: `NewIdeaPage.tsx`, `EditIdeaPage.tsx` - 完整表单处理
- **列表页面**: `HomePage.tsx`, `MePage.tsx` - 数据列表展示
- **认证页面**: `LoginPage.tsx`, `RegisterPage.tsx` - 表单验证和错误处理
- **管理页面**: `AdminUsersPage.tsx` - 搜索、分页、删除操作

### 完整实现的参考组件

- **导航组件**: `Navbar.tsx` - 响应式菜单、语言切换、通知徽章
- **路由守卫**: `ProtectedRoute.tsx` - 权限控制模式
- **OAuth组件**: `OAuthButtons.tsx` - 第三方登录

---

## 🚫 常见错误

### ❌ 不要做的事

1. **不要绕过 `apiFetch`** - 直接使用 `fetch()` 会丢失认证token
2. **不要硬编码文本** - 所有用户可见文本必须使用 `t()` 函数
3. **不要使用 `<a>` 标签** - 用 `<Link>` 进行内部导航
4. **不要忘记错误处理** - 所有 `apiFetch` 调用必须包在 `try-catch` 中
5. **不要跳过加载状态** - 所有异步操作需要loading indicator
6. **不要修改文件后不更新文档** - 每次修改都要同步更新 `PROJECT_STRUCTURE.md`
7. **不要在添加新页面时忘记路由** - 必须在 `App.tsx` 中注册路由

---

## 📚 关键文件速查

### 前端核心文件
- **应用入口**: `client/src/main.tsx` - i18n初始化
- **路由配置**: `client/src/App.tsx` - 所有路由定义在这里
- **认证上下文**: `client/src/authContext.tsx` - 全局用户状态
- **API封装**: `client/src/api.ts` - 统一HTTP请求
- **翻译资源**: `client/src/locales/en.json`, `zh.json`
- **错误处理**: `client/src/utils/humanizeError.ts`

### 后端核心文件
- **应用配置**: `server/src/app.js` - Express中间件链
- **认证配置**: `server/src/config/passport.js` - Passport策略
- **路由入口**: `server/src/routes/*.js` - 所有API端点
- **权限中间件**: `server/src/middleware/auth.js` - 认证和角色检查

---

## 💡 开发提示

1. **优先查找现有实现** - 项目中可能已经有类似功能，避免重复造轮子
2. **保持一致性** - 参考现有页面的代码风格和结构
3. **测试多语言** - 切换语言测试所有新增文本
4. **测试不同角色** - 测试普通用户、公司用户、管理员的不同体验
5. **检查移动端** - 确保响应式设计在小屏幕正常工作

---

## 🔍 检查清单

完成任何修改后，使用此清单自查：

- [ ] 已阅读 `PROJECT_STRUCTURE.md` 相关部分
- [ ] 代码遵循了所有必备功能规范
- [ ] 所有文本已国际化（en.json + zh.json）
- [ ] 所有异步操作有加载状态
- [ ] 所有API调用有错误处理
- [ ] UI样式与现有页面一致
- [ ] 已更新 `PROJECT_STRUCTURE.md`
- [ ] 已在"更新记录"表格添加条目
- [ ] 已测试功能正常工作

---

## 📞 问题排查

如果遇到问题，按此顺序检查：

1. **翻译缺失** → 检查 `locales/en.json` 和 `zh.json`
2. **API请求失败** → 检查是否使用 `apiFetch` 而非 `fetch`
3. **路由不工作** → 检查 `App.tsx` 中是否注册路由
4. **权限问题** → 检查 `ProtectedRoute` 和 `requireRole` 中间件
5. **样式不一致** → 参考其他页面的 Tailwind 类名

---

**记住：每次修改 = 阅读文档 → 实施修改 → 更新文档 → 验证完成**
